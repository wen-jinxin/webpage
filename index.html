<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åƒç´ å†’é™© | Pixel Adventure</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            font-family: "Courier New", monospace;
            min-height: 100vh;
            overflow: hidden;
            padding: 20px;
        }
        /* æ¸¸æˆæ ‡é¢˜ */
        .game-title {
            color: #fff;
            font-size: 28px;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 2px 2px 0 #000, 4px 4px 0 #ff2a6d;
            letter-spacing: 2px;
        }
        /* ç”»å¸ƒå®¹å™¨ - åƒç´ è¾¹æ¡† + é˜´å½± */
        .canvas-container {
            position: relative;
            border: 8px solid #fff;
            border-radius: 4px;
            box-shadow: 0 0 30px rgba(255, 42, 109, 0.5), inset 0 0 20px rgba(0, 0, 0, 0.8);
            background: #000;
        }
        canvas {
            border: 2px solid #333;
            background-color: #ccc;
            image-rendering: pixelated;
            max-width: 100%;
            max-height: 100%;
            display: block;
        }
        .controls {
            color: #fff;
            margin-top: 15px;
            font-size: 14px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 15px;
            border-radius: 4px;
            border: 1px solid #ff2a6d;
        }
        /* ç•Œé¢æ ·å¼ - åƒç´ é£æ ¼ç¾åŒ– */
        .screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(22, 33, 62, 0.95));
            color: #fff;
            padding: 40px;
            border-radius: 8px;
            text-align: center;
            z-index: 100;
            border: 4px solid #ff2a6d;
            box-shadow: 0 0 50px rgba(255, 42, 109, 0.8);
        }
        .screen h1 {
            font-size: 36px;
            margin-bottom: 20px;
            color: #ffd700;
            text-shadow: 2px 2px 0 #ff2a6d, 4px 4px 0 #000;
            letter-spacing: 3px;
        }
        .screen p {
            font-size: 18px;
            margin-bottom: 30px;
            color: #f0f0f0;
        }
        .btn {
            background: linear-gradient(135deg, #ff2a6d, #ff4757);
            color: #fff;
            border: none;
            padding: 12px 24px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            font-family: "Courier New", monospace;
            font-weight: bold;
            transition: all 0.2s ease;
            border: 2px solid #fff;
            box-shadow: 3px 3px 0 #000;
        }
        .btn:hover {
            background: linear-gradient(135deg, #ff4757, #ff6b81);
            transform: translate(-2px, -2px);
            box-shadow: 5px 5px 0 #000;
        }
        .btn:active {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0 #000;
        }
        .btn:disabled {
            background: linear-gradient(135deg, #444, #666);
            cursor: not-allowed;
            color: #888;
            border-color: #888;
            transform: none;
            box-shadow: none;
        }
        .level-btn {
            width: 60px;
            height: 60px;
            margin: 15px;
            font-size: 20px;
            border-radius: 8px;
        }
        /* è½¬åœºæ•ˆæœ - ä¼˜åŒ– */
        .transition {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #000, #ff2a6d);
            opacity: 0;
            z-index: 99;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        /* ç”Ÿå‘½å€¼æ˜¾ç¤º */
        .health-bar {
            position: absolute;
            top: 10px;
            right: 20px;
            display: flex;
            align-items: center;
            z-index: 10;
        }
        .heart {
            width: 20px;
            height: 20px;
            margin-left: 5px;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ff2a6d'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E") no-repeat center;
            background-size: contain;
        }
        .heart.empty {
            filter: grayscale(100%) opacity(0.5);
        }
        /* æ¸¸æˆä¸­çš®è‚¤é€‰æ‹©é¢æ¿ - æ ¸å¿ƒæ–°å¢ */
        .in-game-skin-panel {
            position: absolute;
            top: 70px;
            right: 20px;
            width: 300px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(22, 33, 62, 0.9));
            border: 3px solid #ff2a6d;
            border-radius: 8px;
            padding: 15px;
            z-index: 50;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }
        .in-game-skin-panel.active {
            display: block;
        }
        .skin-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #ffd700;
            padding-bottom: 10px;
        }
        .skin-panel-title {
            color: #ffd700;
            font-size: 18px;
            font-weight: bold;
        }
        .close-skin-panel {
            background: #ff2a6d;
            color: #fff;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* çš®è‚¤åˆ—è¡¨æ ·å¼ */
        .in-game-skin-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .in-game-skin-item {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #333;
            border-radius: 6px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .in-game-skin-item.unlocked {
            border-color: #ffd700;
        }
        .in-game-skin-item.selected {
            border-color: #ff2a6d;
            background: rgba(255, 42, 109, 0.2);
        }
        .in-game-skin-item:hover {
            transform: translateX(5px);
        }
        .skin-top {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .skin-preview-small {
            width: 30px;
            height: 30px;
            border: 2px solid #000;
            margin-right: 10px;
        }
        .skin-info {
            flex: 1;
        }
        .skin-name-small {
            font-size: 14px;
            font-weight: bold;
            color: #fff;
        }
        .skin-unlock-small {
            font-size: 12px;
            color: #888;
        }
        .in-game-skin-item.unlocked .skin-unlock-small {
            color: #4CAF50;
        }
        .skin-effects {
            font-size: 12px;
            color: #ffd700;
            margin-top: 5px;
            padding-left: 10px;
        }
        .current-tag {
            background: #ff2a6d;
            color: #fff;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 3px;
            margin-left: 5px;
        }
        /* çš®è‚¤é€‰æ‹©ç•Œé¢æ ·å¼ */
        .skin-select-screen {
            width: 500px;
            max-width: 90%;
        }
        .skin-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .skin-item {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #333;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .skin-item.unlocked {
            border-color: #ffd700;
        }
        .skin-item.selected {
            border-color: #ff2a6d;
            background: rgba(255, 42, 109, 0.2);
            box-shadow: 0 0 15px rgba(255, 42, 109, 0.5);
        }
        .skin-item:hover {
            transform: scale(1.05);
        }
        .skin-preview {
            width: 40px;
            height: 40px;
            margin: 0 auto 10px;
            border: 2px solid #000;
        }
        .skin-name {
            font-size: 14px;
            margin-bottom: 5px;
        }
        .skin-unlock-condition {
            font-size: 12px;
            color: #888;
        }
        .skin-item.unlocked .skin-unlock-condition {
            color: #4CAF50;
            content: "å·²è§£é”";
        }
        .current-skin-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff2a6d;
            color: #fff;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1 class="game-title">åƒç´ å†’é™© | Pixel Adventure</h1>
    
    <div class="canvas-container">
        <canvas id="gameCanvas" width="640" height="480"></canvas>
        <!-- ç”Ÿå‘½å€¼æ˜¾ç¤º -->
        <div class="health-bar">
            <div class="heart" id="heart1"></div>
            <div class="heart" id="heart2"></div>
            <div class="heart" id="heart3"></div>
        </div>
        <!-- æ¸¸æˆä¸­çš®è‚¤é€‰æ‹©é¢æ¿ - æ ¸å¿ƒæ–°å¢ -->
        <div class="in-game-skin-panel" id="inGameSkinPanel">
            <div class="skin-panel-header">
                <div class="skin-panel-title">çš®è‚¤é€‰æ‹© (æŒ‰Så…³é—­)</div>
                <button class="close-skin-panel" onclick="toggleSkinPanel()">Ã—</button>
            </div>
            <div class="in-game-skin-list" id="inGameSkinList"></div>
        </div>
    </div>
    
    <div class="controls">æ“ä½œï¼šâ† â†’ ç§»åŠ¨ | â†‘ è·³è·ƒ | R é‡æ–°å¼€å§‹ | S æ‰“å¼€çš®è‚¤é¢æ¿ | èº²é¿æ€ªå…½å’Œå°–åˆºï¼</div>
    
    <!-- å¼€å§‹ç•Œé¢ -->
    <div id="startScreen" class="screen">
        <h1>åƒç´ å†’é™©</h1>
        <p>æ”¶é›†æ‰€æœ‰é‡‘å¸ï¼Œé¿å¼€å°–åˆºå’Œæ€ªå…½ï¼ŒæŠµè¾¾ç»ˆç‚¹ï¼<br>æ¯å…³éƒ½æœ‰æ–°çš„æŒ‘æˆ˜åœ¨ç­‰ä½ ï¼</p>
        <button class="btn" onclick="showLevelSelect()">å¼€å§‹æ¸¸æˆ</button>
        <button class="btn" onclick="showSkinSelect()">çš®è‚¤é€‰æ‹©</button>
    </div>
    
    <!-- å…³å¡é€‰æ‹©ç•Œé¢ -->
    <div id="levelSelectScreen" class="screen" style="display: none;">
        <h1>é€‰æ‹©å…³å¡</h1>
        <div id="levelButtons"></div>
        <button class="btn" onclick="showStartScreen()">è¿”å›</button>
    </div>
    
    <!-- é€šå…³å¼¹çª— -->
    <div id="winScreen" class="screen" style="display: none;">
        <h1>æŒ‘æˆ˜æˆåŠŸï¼ğŸ‰</h1>
        <p id="winMessage">ç¬¬ä¸€å…³æ‰€æœ‰é‡‘å¸å·²æ”¶é›†ï¼Œä½ çœŸæ£’ï¼</p>
        <button class="btn" onclick="replayCurrentLevel()">å†ç©ä¸€æ¬¡</button>
        <button class="btn" id="nextLevelBtn">ä¸‹ä¸€å…³</button>
    </div>
    
    <!-- çš®è‚¤é€‰æ‹©ç•Œé¢ -->
    <div id="skinSelectScreen" class="screen skin-select-screen" style="display: none;">
        <h1>çš®è‚¤é€‰æ‹©</h1>
        <p>æ”¶é›†ä¸åŒçš„çš®è‚¤æ¥æ›´æ¢ä½ çš„å¤–è§‚ï¼</p>
        <div class="skin-grid" id="skinGrid"></div>
        <button class="btn" onclick="showStartScreen()">è¿”å›</button>
    </div>
    
    <!-- è½¬åœºé®ç½© -->
    <div id="transition" class="transition"></div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        // åŸå§‹ç”»å¸ƒå°ºå¯¸
        const originalWidth = 640;
        const originalHeight = 480;
        canvas.width = originalWidth;
        canvas.height = originalHeight;

        // å…¨å±€çŠ¶æ€
        let currentLevel = 0;
        let gameState = 'menu'; // menu/playing/lose/win
        let keys = {};
        let coinCount = 0;
        let unlockedLevels = JSON.parse(localStorage.getItem('unlockedLevels')) || [true, false, false];
        let monsters = [];
        let playerInvulnerable = false;
        let invulnerableTimer = 0;
        let playerHealth = 3;
        let coinAnimationFrames = [];
        let particles = [];
        let celebrationParticles = [];
        let jumpParticleCooldown = 0;
        let showSkinPanel = false; // æ¸¸æˆä¸­çš®è‚¤é¢æ¿æ˜¾ç¤ºçŠ¶æ€
        
        // çš®è‚¤ç³»ç»Ÿæ ¸å¿ƒæ•°æ®
        let skinData = {
            unlockedSkins: JSON.parse(localStorage.getItem('unlockedSkins')) || ['default'],
            currentSkin: localStorage.getItem('currentSkin') || 'default',
            totalCoinsCollected: parseInt(localStorage.getItem('totalCoinsCollected')) || 0,
            totalLevelsCompleted: parseInt(localStorage.getItem('totalLevelsCompleted')) || 0
        };

        // è§’è‰²é…ç½®ï¼ˆåŸºç¡€é…ç½®ï¼Œçš®è‚¤ä¼šè¦†ç›–è¿™äº›å±æ€§ï¼‰
        let player = {
            x: 50,
            y: 410,
            size: 12,
            speed: 3.6,
            jumpPower: 10.6,
            gravity: 0.46,
            velocityY: 0,
            onGround: false,
            color: '#00f',
            skin: 'default'
        };

        // çš®è‚¤å®šä¹‰ï¼ˆæ–°å¢è¯¦ç»†åŠŸèƒ½è¯´æ˜ï¼‰
        const skins = [
            {
                id: 'default',
                name: 'é»˜è®¤çš®è‚¤',
                color: '#00f',
                size: 12,
                speed: 3.6,
                jumpPower: 10.6,
                unlockCondition: 'åˆå§‹è§£é”',
                unlocked: true,
                specialEffect: null,
                effectsDesc: 'åŸºç¡€å±æ€§ï¼Œæ— ç‰¹æ®Šæ•ˆæœ'
            },
            {
                id: 'red',
                name: 'çº¢è‰²å‹‡å£«',
                color: '#f00',
                size: 12,
                speed: 3.8,
                jumpPower: 10.4,
                unlockCondition: 'æ”¶é›†10ä¸ªé‡‘å¸',
                unlocked: false,
                specialEffect: 'jumpParticles',
                effectsDesc: 'âœ¦ ç§»åŠ¨é€Ÿåº¦+0.2 âœ¦ è·³è·ƒç²’å­å˜ä¸ºçº¢è‰² âœ¦ è·³è·ƒé«˜åº¦-0.2'
            },
            {
                id: 'yellow',
                name: 'é»„è‰²é—ªç”µ',
                color: '#ff0',
                size: 10,
                speed: 4.2,
                jumpPower: 11.0,
                unlockCondition: 'å®Œæˆç¬¬1å…³',
                unlocked: false,
                specialEffect: 'speed',
                effectsDesc: 'âœ¦ ä½“å‹å˜å°(10px) âœ¦ ç§»åŠ¨é€Ÿåº¦+0.6 âœ¦ è·³è·ƒé«˜åº¦+0.4'
            },
            {
                id: 'green',
                name: 'ç»¿è‰²å¿è€…',
                color: '#0f0',
                size: 11,
                speed: 4.0,
                jumpPower: 10.8,
                unlockCondition: 'æ”¶é›†30ä¸ªé‡‘å¸',
                unlocked: false,
                specialEffect: 'invulnerability',
                effectsDesc: 'âœ¦ ä½“å‹å˜å°(11px) âœ¦ ç§»åŠ¨é€Ÿåº¦+0.4 âœ¦ å—ä¼¤æ— æ•Œæ—¶é—´å»¶é•¿1ç§’ âœ¦ è·³è·ƒé«˜åº¦+0.2'
            },
            {
                id: 'purple',
                name: 'ç´«è‰²å¹½çµ',
                color: '#a0f',
                size: 12,
                speed: 3.9,
                jumpPower: 10.7,
                unlockCondition: 'å®Œæˆç¬¬2å…³',
                unlocked: false,
                specialEffect: 'ghost',
                effectsDesc: 'âœ¦ åŠé€æ˜æ•ˆæœ âœ¦ ç§»åŠ¨é€Ÿåº¦+0.3 âœ¦ è·³è·ƒé«˜åº¦+0.1'
            },
            {
                id: 'orange',
                name: 'æ©™è‰²å¦å…‹',
                color: '#f80',
                size: 14,
                speed: 3.4,
                jumpPower: 10.2,
                unlockCondition: 'æ”¶é›†50ä¸ªé‡‘å¸',
                unlocked: false,
                specialEffect: 'health',
                effectsDesc: 'âœ¦ ä½“å‹å˜å¤§(14px) âœ¦ ç”Ÿå‘½å€¼+1 âœ¦ ç§»åŠ¨é€Ÿåº¦-0.2 âœ¦ è·³è·ƒé«˜åº¦-0.4'
            }
        ];

        // å…³å¡æ•°æ®
        const levelsData = [
            // ç¬¬ä¸€å…³ï¼šåŸºç¡€å…¥é—¨
            {
                platforms: [
                    {id:1, x:0, y:440, w:200, h:40, color: '#4CAF50'},
                    {id:2, x:250, y:400, w:100, h:20, color: '#4CAF50'},
                    {id:3, x:380, y:350, w:100, h:20, color: '#2196F3'},
                    {id:4, x:520, y:300, w:100, h:20, color: '#2196F3'},
                    {id:5, x:450, y:250, w:100, h:20, color: '#FF9800'},
                    {id:6, x:200, y:300, w:100, h:20, color: '#FF9800'},
                    {id:7, x:600, y:200, w:40, h:20, color: '#f00'}
                ],
                spikes: [
                    {platformId:1, x:180, count:2, size:10},
                    {platformId:2, x:330, count:2, size:10},
                    {platformId:4, x:600, count:2, size:10}
                ],
                coins: [
                    {x:150, y:410, size:8}, {x:280, y:380, size:8}, {x:420, y:330, size:8},
                    {x:560, y:280, size:8}, {x:480, y:230, size:8}, {x:250, y:280, size:8},
                    {x:610, y:180, size:8}, {x:300, y:380, size:8}, {x:400, y:330, size:8},
                    {x:540, y:280, size:8}, {x:470, y:230, size:8}, {x:220, y:280, size:8}
                ],
                monsters: [
                    {x: 380, y: 330, size: 14, speed: 1.2, direction: 1, minX: 380, maxX: 480, color: '#e74c3c'}
                ],
                bgColor: '#e0f7fa',
                bgGradient: true
            },
            // ç¬¬äºŒå…³ï¼šè¿›é˜¶æŒ‘æˆ˜
            {
                platforms: [
                    {id:1, x:0, y:440, w:180, h:40, color: '#4CAF50'},
                    {id:2, x:220, y:390, w:100, h:20, color: '#2196F3'},
                    {id:3, x:350, y:330, w:100, h:20, color: '#FF9800'},
                    {id:4, x:480, y:270, w:100, h:20, color: '#9C27B0'},
                    {id:5, x:300, y:220, w:100, h:20, color: '#FF9800'},
                    {id:6, x:500, y:180, w:100, h:20, color: '#2196F3'},
                    {id:7, x:250, y:150, w:60, h:20, color: '#f00'}
                ],
                spikes: [
                    {platformId:1, x:160, count:3, size:10},
                    {platformId:2, x:280, count:2, size:10},
                    {platformId:3, x:410, count:3, size:10},
                    {platformId:6, x:580, count:2, size:10}
                ],
                coins: [
                    {x:120, y:410, size:8}, {x:250, y:370, size:8}, {x:380, y:310, size:8},
                    {x:510, y:250, size:8}, {x:330, y:200, size:8}, {x:530, y:160, size:8},
                    {x:100, y:410, size:8}, {x:230, y:370, size:8}, {x:360, y:310, size:8},
                    {x:490, y:250, size:8}, {x:310, y:200, size:8}, {x:270, y:130, size:8}
                ],
                monsters: [
                    {x: 220, y: 370, size: 14, speed: 1.5, direction: 1, minX: 220, maxX: 320, color: '#e74c3c'},
                    {x: 480, y: 250, size: 14, speed: 1.8, direction: -1, minX: 480, maxX: 580, color: '#e74c3c'}
                ],
                bgColor: '#a8d8ff',
                bgGradient: true
            },
            // ç¬¬ä¸‰å…³ï¼šç»ˆææŒ‘æˆ˜
            {
                platforms: [
                    {id:1, x:0, y:440, w:150, h:40, color: '#9C27B0'},
                    {id:2, x:180, y:380, w:90, h:20, color: '#FF9800'},
                    {id:3, x:300, y:320, w:90, h:20, color: '#2196F3'},
                    {id:4, x:420, y:260, w:90, h:20, color: '#4CAF50'},
                    {id:5, x:300, y:200, w:90, h:20, color: '#FF9800'},
                    {id:6, x:380, y:140, w:90, h:20, color: '#9C27B0'},
                    {id:7, x:520, y:80, w:60, h:20, color: '#f00'}
                ],
                spikes: [
                    {platformId:1, x:130, count:3, size:10},
                    {platformId:2, x:230, count:2, size:10},
                    {platformId:3, x:350, count:3, size:10},
                    {platformId:4, x:470, count:2, size:10},
                    {platformId:6, x:430, count:2, size:10}
                ],
                coins: [
                    {x:90, y:410, size:8}, {x:210, y:360, size:8}, {x:330, y:300, size:8},
                    {x:450, y:240, size:8}, {x:310, y:180, size:8}, {x:410, y:120, size:8},
                    {x:70, y:410, size:8}, {x:190, y:360, size:8}, {x:310, y:300, size:8},
                    {x:430, y:240, size:8}, {x:290, y:180, size:8}, {x:540, y:60, size:8}
                ],
                monsters: [
                    {x: 180, y: 360, size: 14, speed: 2.0, direction: 1, minX: 180, maxX: 270, color: '#e74c3c'},
                    {x: 300, y: 300, size: 14, speed: 2.2, direction: -1, minX: 300, maxX: 390, color: '#e74c3c'},
                    {x: 380, y: 120, size: 14, speed: 2.5, direction: 1, minX: 380, maxX: 470, color: '#e74c3c'}
                ],
                bgColor: '#ffd8a8',
                bgGradient: true
            }
        ];

        // å½“å‰å…³å¡æ•°æ®
        let currentLevelData = levelsData[currentLevel];
        let platforms = currentLevelData.platforms;
        let spikes = currentLevelData.spikes;
        let coins = [];

        // DOMå…ƒç´ 
        const startScreen = document.getElementById('startScreen');
        const levelSelectScreen = document.getElementById('levelSelectScreen');
        const winScreen = document.getElementById('winScreen');
        const skinSelectScreen = document.getElementById('skinSelectScreen');
        const inGameSkinPanel = document.getElementById('inGameSkinPanel');
        const inGameSkinList = document.getElementById('inGameSkinList');
        const winMessage = document.getElementById('winMessage');
        const nextLevelBtn = document.getElementById('nextLevelBtn');
        const transition = document.getElementById('transition');
        const hearts = [
            document.getElementById('heart1'),
            document.getElementById('heart2'),
            document.getElementById('heart3')
        ];

        // ==================== çš®è‚¤ç³»ç»Ÿæ ¸å¿ƒåŠŸèƒ½ ====================
        // åˆå§‹åŒ–çš®è‚¤æ•°æ®
        function initSkinData() {
            // æ£€æŸ¥çš®è‚¤è§£é”æ¡ä»¶
            skins.forEach(skin => {
                if (skin.id === 'default') {
                    skin.unlocked = true;
                    return;
                }

                skin.unlocked = skinData.unlockedSkins.includes(skin.id);
                
                // è‡ªåŠ¨è§£é”æ»¡è¶³æ¡ä»¶çš„çš®è‚¤
                if (!skin.unlocked) {
                    if (skin.unlockCondition.includes('æ”¶é›†') && skin.unlockCondition.includes('é‡‘å¸')) {
                        const requiredCoins = parseInt(skin.unlockCondition.match(/\d+/)[0]);
                        if (skinData.totalCoinsCollected >= requiredCoins) {
                            unlockSkin(skin.id);
                        }
                    } else if (skin.unlockCondition.includes('å®Œæˆç¬¬') && skin.unlockCondition.includes('å…³')) {
                        const requiredLevel = parseInt(skin.unlockCondition.match(/\d+/)[0]);
                        if (skinData.totalLevelsCompleted >= requiredLevel) {
                            unlockSkin(skin.id);
                        }
                    }
                }
            });

            // åº”ç”¨å½“å‰çš®è‚¤
            applySkin(skinData.currentSkin);
            // åˆå§‹åŒ–æ¸¸æˆä¸­çš®è‚¤é¢æ¿
            renderInGameSkinPanel();
        }

        // åˆ‡æ¢æ¸¸æˆä¸­çš®è‚¤é¢æ¿æ˜¾ç¤º/éšè—
        function toggleSkinPanel() {
            showSkinPanel = !showSkinPanel;
            if (showSkinPanel) {
                inGameSkinPanel.classList.add('active');
                renderInGameSkinPanel();
            } else {
                inGameSkinPanel.classList.remove('active');
            }
        }

        // æ¸²æŸ“æ¸¸æˆä¸­çš®è‚¤é¢æ¿
        function renderInGameSkinPanel() {
            inGameSkinList.innerHTML = '';

            skins.forEach(skin => {
                const skinItem = document.createElement('div');
                skinItem.className = `in-game-skin-item ${skin.unlocked ? 'unlocked' : ''} ${skin.id === skinData.currentSkin ? 'selected' : ''}`;
                
                // åªæœ‰å·²è§£é”çš„çš®è‚¤å¯ç‚¹å‡»åˆ‡æ¢
                if (skin.unlocked) {
                    skinItem.onclick = () => {
                        applySkin(skin.id);
                        renderInGameSkinPanel(); // åˆ·æ–°é¢æ¿çŠ¶æ€
                    };
                }

                const unlockText = skin.unlocked ? 'å·²è§£é”' : skin.unlockCondition;
                const currentTag = skin.id === skinData.currentSkin ? '<span class="current-tag">å½“å‰</span>' : '';

                skinItem.innerHTML = `
                    <div class="skin-top">
                        <div class="skin-preview-small" style="background-color: ${skin.color};"></div>
                        <div class="skin-info">
                            <div class="skin-name-small">${skin.name} ${currentTag}</div>
                            <div class="skin-unlock-small">${unlockText}</div>
                        </div>
                    </div>
                    <div class="skin-effects">${skin.effectsDesc}</div>
                `;

                inGameSkinList.appendChild(skinItem);
            });
        }

        // è§£é”çš®è‚¤
        function unlockSkin(skinId) {
            if (!skinData.unlockedSkins.includes(skinId)) {
                skinData.unlockedSkins.push(skinId);
                localStorage.setItem('unlockedSkins', JSON.stringify(skinData.unlockedSkins));
                
                const skin = skins.find(s => s.id === skinId);
                if (skin) {
                    skin.unlocked = true;
                }
                
                // æ›´æ–°æ‰€æœ‰çš®è‚¤é¢æ¿
                renderSkinSelectScreen();
                renderInGameSkinPanel();
            }
        }

        // åº”ç”¨çš®è‚¤ï¼ˆæ¸¸æˆä¸­å®æ—¶ç”Ÿæ•ˆï¼‰
        function applySkin(skinId) {
            const skin = skins.find(s => s.id === skinId);
            if (!skin || !skin.unlocked) return;

            // ä¿å­˜å½“å‰çš®è‚¤
            skinData.currentSkin = skinId;
            localStorage.setItem('currentSkin', skinId);
            player.skin = skinId;

            // åº”ç”¨çš®è‚¤å±æ€§ï¼ˆå®æ—¶ç”Ÿæ•ˆï¼‰
            player.color = skin.color;
            player.size = skin.size;
            player.speed = skin.speed;
            player.jumpPower = skin.jumpPower;

            // åº”ç”¨çš®è‚¤ç‰¹æ®Šæ•ˆæœ
            applySkinSpecialEffects(skin);

            // æ›´æ–°æ‰€æœ‰çš®è‚¤é¢æ¿
            renderSkinSelectScreen();
            renderInGameSkinPanel();
            updateHealthDisplay(); // ç”Ÿå‘½å€¼å¯èƒ½å˜åŒ–
        }

        // åº”ç”¨çš®è‚¤ç‰¹æ®Šæ•ˆæœ
        function applySkinSpecialEffects(skin) {
            // é‡ç½®æ‰€æœ‰ç‰¹æ®Šæ•ˆæœ
            player.extraHealth = 0;
            player.extraInvulnerability = 0;

            // åº”ç”¨å½“å‰çš®è‚¤çš„ç‰¹æ®Šæ•ˆæœ
            switch (skin.specialEffect) {
                case 'health':
                    player.extraHealth = 1;
                    break;
                case 'invulnerability':
                    player.extraInvulnerability = 30; // é¢å¤–30å¸§æ— æ•Œæ—¶é—´
                    break;
                default:
                    break;
            }
        }

        // ä¿å­˜çš®è‚¤ç»Ÿè®¡æ•°æ®
        function saveSkinStats(coinsCollected, levelCompleted) {
            skinData.totalCoinsCollected += coinsCollected;
            if (levelCompleted) {
                skinData.totalLevelsCompleted++;
            }

            localStorage.setItem('totalCoinsCollected', skinData.totalCoinsCollected);
            localStorage.setItem('totalLevelsCompleted', skinData.totalLevelsCompleted);

            // æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš®è‚¤å¯ä»¥è§£é”
            initSkinData();
        }

        // æ¸²æŸ“ä¸»èœå•çš®è‚¤é€‰æ‹©ç•Œé¢
        function renderSkinSelectScreen() {
            const skinGrid = document.getElementById('skinGrid');
            skinGrid.innerHTML = '';

            skins.forEach(skin => {
                const skinItem = document.createElement('div');
                skinItem.className = `skin-item ${skin.unlocked ? 'unlocked' : ''} ${skin.id === skinData.currentSkin ? 'selected' : ''}`;
                skinItem.onclick = () => {
                    if (skin.unlocked) {
                        applySkin(skin.id);
                    }
                };

                const unlockText = skin.unlocked 
                    ? 'å·²è§£é”' 
                    : skin.unlockCondition;

                skinItem.innerHTML = `
                    <div class="skin-preview" style="background-color: ${skin.color};"></div>
                    <div class="skin-name">${skin.name}</div>
                    <div class="skin-unlock-condition">${unlockText}</div>
                    <div class="skin-effects" style="font-size:10px;margin-top:5px;">${skin.effectsDesc}</div>
                    ${skin.id === skinData.currentSkin ? '<div class="current-skin-indicator">å½“å‰</div>' : ''}
                `;

                skinGrid.appendChild(skinItem);
            });
        }

        // æ˜¾ç¤ºçš®è‚¤é€‰æ‹©ç•Œé¢
        function showSkinSelect() {
            showTransition();
            setTimeout(() => {
                renderSkinSelectScreen();
                skinSelectScreen.style.display = 'block';
                startScreen.style.display = 'none';
                levelSelectScreen.style.display = 'none';
                winScreen.style.display = 'none';
                hideTransition();
            }, 300);
        }

        // åˆå§‹åŒ–å…³å¡æŒ‰é’®
        function initLevelButtons() {
            const levelButtons = document.getElementById('levelButtons');
            levelButtons.innerHTML = '';
            levelsData.forEach((_, index) => {
                const btn = document.createElement('button');
                btn.className = 'btn level-btn';
                btn.textContent = index + 1;
                btn.disabled = !unlockedLevels[index];
                btn.onclick = () => loadLevel(index);
                levelButtons.appendChild(btn);
            });
        }

        // æ›´æ–°ç”Ÿå‘½å€¼æ˜¾ç¤º
        function updateHealthDisplay() {
            const totalHealth = playerHealth + (player.extraHealth || 0);
            for (let i = 0; i < hearts.length; i++) {
                if (i < totalHealth) {
                    hearts[i].classList.remove('empty');
                } else {
                    hearts[i].classList.add('empty');
                }
            }
        }

        // åŠ è½½å…³å¡
        function loadLevel(levelIndex) {
            if (!unlockedLevels[levelIndex]) return;
            
            showTransition();
            setTimeout(() => {
                currentLevel = levelIndex;
                currentLevelData = levelsData[currentLevel];
                
                // é‡ç½®æ¸¸æˆçŠ¶æ€
                platforms = currentLevelData.platforms;
                spikes = currentLevelData.spikes;
                coins = currentLevelData.coins.map(coin => ({...coin, collected: false}));
                monsters = JSON.parse(JSON.stringify(currentLevelData.monsters));
                coinCount = 0;
                gameState = 'playing';
                playerInvulnerable = false;
                invulnerableTimer = 0;
                playerHealth = 3;
                coinAnimationFrames = [];
                particles = [];
                celebrationParticles = [];
                jumpParticleCooldown = 0;
                
                // é‡ç½®è§’è‰²ä½ç½®ï¼Œä¿ç•™çš®è‚¤å±æ€§
                player.x = 50;
                player.y = 410;
                player.velocityY = 0;
                player.onGround = false;
                
                // æ›´æ–°ç”Ÿå‘½å€¼æ˜¾ç¤º
                updateHealthDisplay();
                
                // éšè—ç•Œé¢
                startScreen.style.display = 'none';
                levelSelectScreen.style.display = 'none';
                winScreen.style.display = 'none';
                skinSelectScreen.style.display = 'none';
                inGameSkinPanel.classList.remove('active');
                showSkinPanel = false;
                
                hideTransition();
            }, 500);
        }

        // é‡æ–°ç©å½“å‰å…³å¡
        function replayCurrentLevel() {
            loadLevel(currentLevel);
        }

        // ç©å®¶å—ä¼¤å¤„ç†
        function playerHurt() {
            if (playerInvulnerable) return;
            
            playerHealth--;
            playerInvulnerable = true;
            // åº”ç”¨çš®è‚¤çš„é¢å¤–æ— æ•Œæ—¶é—´
            invulnerableTimer = 60 + (player.extraInvulnerability || 0);
            updateHealthDisplay();
            
            // ç”Ÿæˆå—ä¼¤è¡€èŠ±ç²’å­
            createBloodParticles(player.x + player.size/2, player.y + player.size/2);
            
            if (playerHealth <= 0) {
                gameState = 'lose';
            }
        }

        // è½¬åœºæ•ˆæœ
        function showTransition() {
            transition.style.opacity = 1;
            transition.style.pointerEvents = 'auto';
        }
        function hideTransition() {
            setTimeout(() => {
                transition.style.opacity = 0;
                transition.style.pointerEvents = 'none';
            }, 100);
        }

        // ç•Œé¢åˆ‡æ¢
        function showStartScreen() {
            showTransition();
            setTimeout(() => {
                startScreen.style.display = 'block';
                levelSelectScreen.style.display = 'none';
                winScreen.style.display = 'none';
                skinSelectScreen.style.display = 'none';
                inGameSkinPanel.classList.remove('active');
                showSkinPanel = false;
                hideTransition();
            }, 300);
        }
        function showLevelSelect() {
            showTransition();
            setTimeout(() => {
                initLevelButtons();
                levelSelectScreen.style.display = 'block';
                startScreen.style.display = 'none';
                winScreen.style.display = 'none';
                skinSelectScreen.style.display = 'none';
                inGameSkinPanel.classList.remove('active');
                showSkinPanel = false;
                hideTransition();
            }, 300);
        }

        // é”®ç›˜æ§åˆ¶ï¼ˆæ–°å¢Sé”®æ‰“å¼€çš®è‚¤é¢æ¿ï¼‰
        document.addEventListener('keydown', e => {
            keys[e.key] = true;
            
            // Ré”®é‡æ–°å¼€å§‹
            if ((e.key === 'r' || e.key === 'R') && gameState !== 'menu') {
                replayCurrentLevel();
            }
            
            // Sé”®æ‰“å¼€/å…³é—­çš®è‚¤é¢æ¿
            if (e.key === 's' || e.key === 'S') {
                toggleSkinPanel();
            }
        });
        document.addEventListener('keyup', e => keys[e.key] = false);

        // ç¢°æ’æ£€æµ‹
        function rectCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.w &&
                   rect1.x + rect1.w > rect2.x &&
                   rect1.y < rect2.y + rect2.h &&
                   rect1.y + rect1.h > rect2.y;
        }

        // è·å–å¹³å°Yåæ ‡
        function getPlatformY(platformId) {
            const platform = platforms.find(p => p.id === platformId);
            return platform ? platform.y : 0;
        }

        // æ›´æ–°æ€ªå…½ç§»åŠ¨é€»è¾‘
        function updateMonsters() {
            if (gameState !== 'playing') return;
            
            monsters.forEach(monster => {
                monster.x += monster.speed * monster.direction;
                
                if (monster.x <= monster.minX) {
                    monster.direction = 1;
                } else if (monster.x >= monster.maxX - monster.size) {
                    monster.direction = -1;
                }
                
                const playerHitbox = {x: player.x, y: player.y, w: player.size, h: player.size};
                const monsterHitbox = {x: monster.x, y: monster.y, w: monster.size, h: monster.size};
                
                if (rectCollision(playerHitbox, monsterHitbox)) {
                    playerHurt();
                }
            });
        }

        // æ·»åŠ é‡‘å¸æ”¶é›†åŠ¨ç”»
        function addCoinAnimation(x, y) {
            coinAnimationFrames.push({
                x: x,
                y: y,
                size: 8,
                frame: 0,
                maxFrames: 15
            });
        }

        // æ›´æ–°é‡‘å¸åŠ¨ç”»
        function updateCoinAnimations() {
            for (let i = coinAnimationFrames.length - 1; i >= 0; i--) {
                const anim = coinAnimationFrames[i];
                anim.frame++;
                anim.y -= 2;
                anim.size *= 0.9;
                
                if (anim.frame >= anim.maxFrames) {
                    coinAnimationFrames.splice(i, 1);
                }
            }
        }

        // ç²’å­ç³»ç»Ÿ
        function createJumpParticles(x, y) {
            if (jumpParticleCooldown > 0) return;
            
            jumpParticleCooldown = 15;
            const particleCount = 5;
            
            // è·å–å½“å‰çš®è‚¤çš„è·³è·ƒç²’å­é¢œè‰²
            const currentSkin = skins.find(s => s.id === player.skin);
            const particleColor = currentSkin && currentSkin.specialEffect === 'jumpParticles' 
                ? currentSkin.color 
                : '#8B4513';
            
            for (let i = 0; i < particleCount; i++) {
                particles.push({
                    x: x + player.size/2,
                    y: y + player.size,
                    size: Math.random() * 3 + 1,
                    speedX: (Math.random() - 0.5) * 2,
                    speedY: Math.random() * -1,
                    life: 30,
                    color: particleColor,
                    type: 'jump'
                });
            }
        }

        function createBloodParticles(x, y) {
            const particleCount = 15;
            
            for (let i = 0; i < particleCount; i++) {
                particles.push({
                    x: x,
                    y: y,
                    size: Math.random() * 4 + 2,
                    speedX: (Math.random() - 0.5) * 6,
                    speedY: (Math.random() - 0.5) * 6,
                    life: 45,
                    color: '#FF0000',
                    type: 'blood'
                });
            }
        }

        function createCelebrationParticles() {
            celebrationParticles = [];
            const particleCount = 100;
            
            for (let i = 0; i < particleCount; i++) {
                const colors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#FFFFFF'];
                celebrationParticles.push({
                    x: Math.random() * originalWidth,
                    y: -10,
                    size: Math.random() * 5 + 2,
                    speedY: Math.random() * 3 + 1,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    life: originalHeight / (Math.random() * 3 + 1) + 10
                });
            }
        }

        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.speedX;
                p.y += p.speedY;
                p.life--;
                
                if (p.type === 'jump') {
                    p.speedY += 0.1;
                }
                
                if (p.life <= 0) {
                    particles.splice(i, 1);
                }
            }
            
            for (let i = celebrationParticles.length - 1; i >= 0; i--) {
                const p = celebrationParticles[i];
                p.y += p.speedY;
                p.life--;
                
                if (p.life <= 0) {
                    celebrationParticles.splice(i, 1);
                }
            }
            
            if (jumpParticleCooldown > 0) {
                jumpParticleCooldown--;
            }
        }

        // æ›´æ–°è§’è‰²
        function updatePlayer() {
            if (gameState !== 'playing') {
                if (gameState === 'win' && celebrationParticles.length < 50) {
                    createCelebrationParticles();
                }
                return;
            }

            updateMonsters();

            if (playerInvulnerable) {
                invulnerableTimer--;
                if (invulnerableTimer <= 0) {
                    playerInvulnerable = false;
                }
            }

            updateCoinAnimations();
            updateParticles();

            let moveX = 0;
            if (keys['ArrowLeft']) moveX = -player.speed;
            if (keys['ArrowRight']) moveX = player.speed;

            const futureX = player.x + moveX;
            const playerRectX = {x: futureX, y: player.y, w: player.size, h: player.size};
            let canMoveX = true;
            
            if (futureX < 0 || futureX + player.size > originalWidth) {
                canMoveX = false;
            }
            platforms.forEach(p => {
                if (rectCollision(playerRectX, p)) canMoveX = false;
            });
            
            if (canMoveX) player.x = futureX;

            if (keys['ArrowUp'] && player.onGround) {
                player.velocityY = -player.jumpPower;
                player.onGround = false;
                createJumpParticles(player.x, player.y);
            }

            player.velocityY += player.gravity;
            
            const futureY = player.y + player.velocityY;
            const playerRectY = {x: player.x, y: futureY, w: player.size, h: player.size};
            let canMoveY = true;
            platforms.forEach(p => {
                if (rectCollision(playerRectY, p)) {
                    canMoveY = false;
                    if (player.velocityY > 0) {
                        player.y = p.y - player.size;
                        player.velocityY = 0;
                        player.onGround = true;
                    } else {
                        player.y = p.y + p.h;
                        player.velocityY = 0;
                    }
                }
            });
            if (canMoveY) {
                player.y = futureY;
                player.onGround = false;
            }

            coins.forEach(coin => {
                if (!coin.collected && rectCollision(
                    {x: player.x, y: player.y, w: player.size, h: player.size},
                    {x: coin.x, y: coin.y, w: coin.size, h: coin.size}
                )) {
                    coin.collected = true;
                    coinCount++;
                    addCoinAnimation(coin.x, coin.y);
                }
            });

            const playerHitbox = {x: player.x + 2, y: player.y + 2, w: player.size - 4, h: player.size - 4};
            spikes.forEach(s => {
                const platform = platforms.find(p => p.id === s.platformId);
                if (!platform) return;
                const platformY = platform.y;
                const platformW = platform.w;
                
                for (let i=0; i<s.count; i++) {
                    const spikeX = s.x + i * s.size;
                    if (spikeX < platform.x || spikeX + s.size > platform.x + platformW) continue;
                    
                    const spikeHitbox = {
                        x: spikeX + 1, 
                        y: platformY - s.size + 2, 
                        w: s.size - 2, 
                        h: s.size - 2
                    };
                    
                    if (rectCollision(playerHitbox, spikeHitbox)) {
                        playerHurt();
                    }
                }
            });

            if (player.y > canvas.height + 50) {
                gameState = 'lose';
                // ä¿å­˜æ”¶é›†çš„é‡‘å¸æ•°é‡
                saveSkinStats(coinCount, false);
            }

            const totalCoins = coins.length;
            const endPlatform = platforms.find(p => p.id === 7);
            const playerRect = {x: player.x, y: player.y, w: player.size, h: player.size};
            const endPlatformRect = {
                x: endPlatform.x - 5,
                y: endPlatform.y - 5,
                w: endPlatform.w + 10,
                h: endPlatform.h + 10
            };

            if (gameState === 'playing' && coinCount === totalCoins && rectCollision(playerRect, endPlatformRect)) {
                gameState = 'win';
                createCelebrationParticles();
                if (currentLevel + 1 < levelsData.length) {
                    unlockedLevels[currentLevel + 1] = true;
                    localStorage.setItem('unlockedLevels', JSON.stringify(unlockedLevels));
                }
                winMessage.textContent = `ç¬¬${currentLevel + 1}å…³æ‰€æœ‰é‡‘å¸å·²æ”¶é›†ï¼ŒæŒ‘æˆ˜æˆåŠŸï¼`;
                
                // ä¿å­˜å…³å¡å®Œæˆæ•°æ®
                saveSkinStats(coinCount, true);
                
                if (currentLevel + 1 < levelsData.length) {
                    nextLevelBtn.textContent = 'ä¸‹ä¸€å…³';
                    nextLevelBtn.onclick = () => loadLevel(currentLevel + 1);
                    nextLevelBtn.disabled = false;
                } else {
                    nextLevelBtn.textContent = 'è¿”å›ä¸»èœå•';
                    nextLevelBtn.onclick = showStartScreen;
                }
                winScreen.style.display = 'block';
            }
        }

        // ç»˜åˆ¶æ¸¸æˆ
        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (currentLevelData.bgGradient) {
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, currentLevelData.bgColor);
                gradient.addColorStop(1, '#ffffff');
                ctx.fillStyle = gradient;
            } else {
                ctx.fillStyle = currentLevelData.bgColor;
            }
            ctx.fillRect(0, 0, originalWidth, originalHeight);

            platforms.forEach(p => {
                ctx.fillStyle = p.color || '#000';
                ctx.fillRect(p.x, p.y, p.w, p.h);
                
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 1;
                ctx.strokeRect(p.x, p.y, p.w, p.h);
                
                if (p.id === 7) {
                    ctx.fillStyle = '#fff';
                    ctx.font = '12px Courier New';
                    ctx.fillText('ç»ˆç‚¹', p.x + 5, p.y + 15);
                    
                    if (Math.floor(Date.now() / 500) % 2 === 0) {
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                        ctx.fillRect(p.x, p.y, p.w, p.h);
                    }
                }
            });

            ctx.fillStyle = '#d32f2f';
            spikes.forEach(s => {
                const platform = platforms.find(p => p.id === s.platformId);
                if (!platform) return;
                const platformY = platform.y;
                const platformW = platform.w;
                for (let i=0; i<s.count; i++) {
                    const x = s.x + i*s.size;
                    if (x >= platform.x && x + s.size <= platform.x + platformW) {
                        ctx.beginPath();
                        ctx.moveTo(x + s.size/2, platformY - s.size);
                        ctx.lineTo(x, platformY);
                        ctx.lineTo(x + s.size, platformY);
                        ctx.fill();
                        
                        ctx.fillStyle = '#b71c1c';
                        ctx.beginPath();
                        ctx.moveTo(x + s.size/2, platformY - s.size + 2);
                        ctx.lineTo(x + 2, platformY);
                        ctx.lineTo(x + s.size - 2, platformY);
                        ctx.fill();
                        ctx.fillStyle = '#d32f2f';
                    }
                }
            });

            ctx.fillStyle = '#ffd700';
            coins.forEach(coin => {
                if (!coin.collected) {
                    if (Math.floor(Date.now() / 300) % 2 === 0) {
                        ctx.fillStyle = '#ffff00';
                    } else {
                        ctx.fillStyle = '#ffd700';
                    }
                    ctx.fillRect(coin.x, coin.y, coin.size, coin.size);
                    
                    ctx.strokeStyle = '#ff8c00';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(coin.x, coin.y, coin.size, coin.size);
                }
            });

            coinAnimationFrames.forEach(anim => {
                ctx.fillStyle = 'rgba(255, 215, 0, ' + (1 - anim.frame / anim.maxFrames) + ')';
                ctx.fillRect(anim.x, anim.y, anim.size, anim.size);
            });

            monsters.forEach(monster => {
                ctx.fillStyle = monster.color;
                ctx.fillRect(monster.x, monster.y, monster.size, monster.size);
                
                ctx.fillStyle = '#c0392b';
                ctx.fillRect(monster.x + 2, monster.y + 2, monster.size, monster.size);
                
                ctx.fillStyle = monster.color;
                ctx.fillRect(monster.x, monster.y, monster.size, monster.size - 2);
                
                ctx.fillStyle = '#fff';
                if (monster.direction === 1) {
                    ctx.fillRect(monster.x + 6, monster.y + 3, 3, 3);
                    ctx.fillRect(monster.x + 10, monster.y + 3, 3, 3);
                } else {
                    ctx.fillRect(monster.x + 3, monster.y + 3, 3, 3);
                    ctx.fillRect(monster.x + 7, monster.y + 3, 3, 3);
                }
                
                ctx.fillStyle = '#000';
                if (monster.direction === 1) {
                    ctx.fillRect(monster.x + 7, monster.y + 4, 1, 1);
                    ctx.fillRect(monster.x + 11, monster.y + 4, 1, 1);
                } else {
                    ctx.fillRect(monster.x + 4, monster.y + 4, 1, 1);
                    ctx.fillRect(monster.x + 8, monster.y + 4, 1, 1);
                }
                
                ctx.fillStyle = '#000';
                ctx.fillRect(monster.x + 3, monster.y + 8, 8, 3);
            });

            // è§’è‰²ç»˜åˆ¶ - é€‚é…çš®è‚¤ç‰¹æ®Šæ•ˆæœ
            if (!playerInvulnerable || Math.floor(Date.now() / 100) % 2 === 0) {
                const currentSkin = skins.find(s => s.id === player.skin);
                
                // å¹½çµçš®è‚¤åŠé€æ˜æ•ˆæœ
                if (currentSkin && currentSkin.specialEffect === 'ghost') {
                    ctx.globalAlpha = 0.7;
                }
                
                ctx.fillStyle = player.color;
                ctx.fillRect(player.x, player.y, player.size, player.size);
                
                // è§’è‰²é˜´å½±
                ctx.fillStyle = currentSkin ? darkenColor(currentSkin.color) : '#000080';
                ctx.fillRect(player.x + 2, player.y + 2, player.size, player.size);
                
                // è§’è‰²ä¸»ä½“ï¼ˆä¸Šå±‚ï¼‰
                ctx.fillStyle = player.color;
                ctx.fillRect(player.x, player.y, player.size, player.size - 2);
                
                // è§’è‰²çœ¼ç›
                ctx.fillStyle = '#fff';
                const eyeOffset = player.size === 10 ? 2 : 3;
                const eyeSize = player.size === 14 ? 4 : 3;
                ctx.fillRect(player.x + eyeOffset, player.y + eyeOffset, eyeSize, eyeSize);
                ctx.fillRect(player.x + (player.size - eyeOffset - eyeSize), player.y + eyeOffset, eyeSize, eyeSize);
                
                // è§’è‰²çœ¼ç 
                ctx.fillStyle = '#000';
                ctx.fillRect(player.x + eyeOffset + 1, player.y + eyeOffset + 1, 1, 1);
                ctx.fillRect(player.x + (player.size - eyeOffset - eyeSize) + 1, player.y + eyeOffset + 1, 1, 1);
                
                // æ¢å¤é€æ˜åº¦
                if (currentSkin && currentSkin.specialEffect === 'ghost') {
                    ctx.globalAlpha = 1.0;
                }
            }

            // ç»˜åˆ¶ç²’å­ç³»ç»Ÿ
            particles.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, p.size, p.size);
            });
            
            celebrationParticles.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, p.size, p.size);
            });

            // å…³å¡ä¿¡æ¯ - ç¾åŒ–æ˜¾ç¤º
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(10, 10, 220, 30);
            ctx.fillStyle = '#90f';
            ctx.font = '16px Courier New';
            ctx.fillText(`å…³å¡ ${currentLevel + 1} | é‡‘å¸ ${coinCount} / ${coins.length}`, 20, 30);

            // çš®è‚¤ä¿¡æ¯æ˜¾ç¤º
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(10, 45, 220, 30);
            const currentSkin = skins.find(s => s.id === player.skin);
            ctx.fillStyle = currentSkin ? currentSkin.color : '#90f';
            ctx.font = '16px Courier New';
            ctx.fillText(`çš®è‚¤: ${currentSkin ? currentSkin.name : 'é»˜è®¤'}`, 20, 65);

            // å¤±è´¥æç¤º - ç¾åŒ–
            if (gameState === 'lose') {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                ctx.fillRect(originalWidth/2 - 100, originalHeight/2 - 40, 200, 80);
                ctx.fillStyle = '#ff2a6d';
                ctx.font = '24px Courier New';
                ctx.fillText('GAME OVER', originalWidth/2 - 70, originalHeight/2);
                ctx.fillStyle = '#fff';
                ctx.font = '16px Courier New';
                ctx.fillText('Press R to Restart', originalWidth/2 - 65, originalHeight/2 + 30);
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šåŠ æ·±é¢œè‰²ï¼ˆç”¨äºè§’è‰²é˜´å½±ï¼‰
        function darkenColor(color) {
            if (color === '#00f') return '#000080';
            if (color === '#f00') return '#800000';
            if (color === '#ff0') return '#808000';
            if (color === '#0f0') return '#008000';
            if (color === '#a0f') return '#500080';
            if (color === '#f80') return '#804000';
            return '#000080';
        }

        // æ¸¸æˆå¾ªç¯
        function gameLoop() {
            updatePlayer();
            drawGame();
            requestAnimationFrame(gameLoop);
        }

        // åˆå§‹åŒ–
        initLevelButtons();
        initSkinData(); // åˆå§‹åŒ–çš®è‚¤ç³»ç»Ÿ
        updateHealthDisplay();
        gameLoop();
    </script>
</body>
</html>
