<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åƒç´ å†’é™©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #333;
            font-family: "Courier New", monospace;
            min-height: 100vh;
            overflow: hidden;
            padding: 20px;
        }
        canvas {
            border: 2px solid #000;
            background-color: #ccc;
            image-rendering: pixelated;
            max-width: 100%;
            max-height: 100%;
        }
        .controls {
            color: #fff;
            margin-top: 10px;
            font-size: 14px;
            z-index: 10;
        }
        /* ç•Œé¢æ ·å¼ */
        .screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0,0,0,0.8);
            color: #fff;
            padding: 40px;
            border-radius: 8px;
            text-align: center;
            z-index: 100;
        }
        .btn {
            background-color: #666;
            color: #fff;
            border: none;
            padding: 12px 24px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            font-family: "Courier New", monospace;
        }
        .btn:hover {
            background-color: #99f;
        }
        .btn:disabled {
            background-color: #444;
            cursor: not-allowed;
            color: #888;
        }
        .level-btn {
            width: 60px;
            height: 60px;
            margin: 15px;
            font-size: 20px;
        }
        /* è½¬åœºæ•ˆæœ */
        .transition {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            opacity: 0;
            z-index: 99;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="640" height="480"></canvas>
    <div class="controls">æ“ä½œï¼šâ† â†’ ç§»åŠ¨ | â†‘ è·³è·ƒ | R é‡æ–°å¼€å§‹</div>
    
    <!-- å¼€å§‹ç•Œé¢ -->
    <div id="startScreen" class="screen">
        <h1>åƒç´ å†’é™©</h1>
        <p>æ”¶é›†æ‰€æœ‰é‡‘å¸ï¼Œé¿å¼€å°–åˆºï¼ŒæŠµè¾¾ç»ˆç‚¹ï¼</p>
        <button class="btn" onclick="showLevelSelect()">å¼€å§‹æ¸¸æˆ</button>
    </div>
    
    <!-- å…³å¡é€‰æ‹©ç•Œé¢ -->
    <div id="levelSelectScreen" class="screen" style="display: none;">
        <h1>é€‰æ‹©å…³å¡</h1>
        <div id="levelButtons"></div>
        <button class="btn" onclick="showStartScreen()">è¿”å›</button>
    </div>
    
    <!-- é€šå…³å¼¹çª— -->
    <div id="winScreen" class="screen" style="display: none;">
        <h1>æŒ‘æˆ˜æˆåŠŸï¼ğŸ‰</h1>
        <p id="winMessage">ç¬¬ä¸€å…³æ‰€æœ‰é‡‘å¸å·²æ”¶é›†ï¼Œä½ çœŸæ£’ï¼</p>
        <button class="btn" onclick="replayCurrentLevel()">å†ç©ä¸€æ¬¡</button>
        <button class="btn" id="nextLevelBtn" onclick="loadLevel(1)">ä¸‹ä¸€å…³</button>
    </div>
    
    <!-- è½¬åœºé®ç½© -->
    <div id="transition" class="transition"></div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        // åŸå§‹ç”»å¸ƒå°ºå¯¸
        const originalWidth = 640;
        const originalHeight = 480;
        canvas.width = originalWidth;
        canvas.height = originalHeight;

        // å…¨å±€çŠ¶æ€
        let currentLevel = 0;
        let gameState = 'menu'; // menu/playing/lose/win
        let keys = {};
        let coinCount = 0;
        let unlockedLevels = JSON.parse(localStorage.getItem('unlockedLevels')) || [true, false, false];
        
        // è§’è‰²é…ç½®ï¼ˆæœ€ç»ˆä¼˜åŒ–ç‰ˆï¼šä¸‰å…³é€šç”¨ï¼Œæ‰‹æ„Ÿæµç•…ï¼‰
        const player = {
            x: 50,
            y: 410,
            size: 12,
            speed: 3.6,
            jumpPower: 10.6,
            gravity: 0.46,
            velocityY: 0,
            onGround: false
        };

        // å…³å¡æ•°æ®ï¼ˆæœ€ç»ˆä¿®å¤ç‰ˆï¼šä¸‰å…³å¸ƒå±€åˆç†ï¼Œéš¾åº¦æ¸è¿›ï¼‰
        const levelsData = [
            // ç¬¬ä¸€å…³ï¼šåŸºç¡€å…¥é—¨
            {
                platforms: [
                    {id:1, x:0, y:440, w:200, h:40},
                    {id:2, x:250, y:400, w:100, h:20},
                    {id:3, x:380, y:350, w:100, h:20},
                    {id:4, x:520, y:300, w:100, h:20},
                    {id:5, x:450, y:250, w:100, h:20},
                    {id:6, x:200, y:300, w:100, h:20},
                    {id:7, x:600, y:200, w:40, h:20, color: '#f00'} // ç»ˆç‚¹å¹³å°ï¼šçº¢è‰²æ ‡è®°
                ],
                spikes: [
                    {platformId:1, x:180, count:2, size:10},
                    {platformId:2, x:330, count:2, size:10},
                    {platformId:4, x:600, count:2, size:10}
                ],
                coins: [
                    {x:150, y:410, size:8}, {x:280, y:380, size:8}, {x:420, y:330, size:8},
                    {x:560, y:280, size:8}, {x:480, y:230, size:8}, {x:250, y:280, size:8},
                    {x:610, y:180, size:8}, {x:300, y:380, size:8}, {x:400, y:330, size:8},
                    {x:540, y:280, size:8}, {x:470, y:230, size:8}, {x:220, y:280, size:8}
                ],
                bgColor: '#ccc'
            },
            // ç¬¬äºŒå…³ï¼šè¿›é˜¶æŒ‘æˆ˜
            {
                platforms: [
                    {id:1, x:0, y:440, w:180, h:40},
                    {id:2, x:220, y:390, w:100, h:20},
                    {id:3, x:350, y:330, w:100, h:20},
                    {id:4, x:480, y:270, w:100, h:20},
                    {id:5, x:300, y:220, w:100, h:20},
                    {id:6, x:500, y:180, w:100, h:20},
                    {id:7, x:250, y:150, w:60, h:20, color: '#f00'}
                ],
                spikes: [
                    {platformId:1, x:160, count:3, size:10},
                    {platformId:2, x:280, count:2, size:10},
                    {platformId:3, x:410, count:3, size:10},
                    {platformId:6, x:580, count:2, size:10}
                ],
                coins: [
                    {x:120, y:410, size:8}, {x:250, y:370, size:8}, {x:380, y:310, size:8},
                    {x:510, y:250, size:8}, {x:330, y:200, size:8}, {x:530, y:160, size:8},
                    {x:100, y:410, size:8}, {x:230, y:370, size:8}, {x:360, y:310, size:8},
                    {x:490, y:250, size:8}, {x:310, y:200, size:8}, {x:270, y:130, size:8}
                ],
                bgColor: '#a8d8ff'
            },
            // ç¬¬ä¸‰å…³ï¼šç»ˆææŒ‘æˆ˜
            {
                platforms: [
                    {id:1, x:0, y:440, w:150, h:40},
                    {id:2, x:180, y:380, w:90, h:20},
                    {id:3, x:300, y:320, w:90, h:20},
                    {id:4, x:420, y:260, w:90, h:20},
                    {id:5, x:300, y:200, w:90, h:20},
                    {id:6, x:380, y:140, w:90, h:20},
                    {id:7, x:520, y:80, w:60, h:20, color: '#f00'}
                ],
                spikes: [
                    {platformId:1, x:130, count:3, size:10},
                    {platformId:2, x:230, count:2, size:10},
                    {platformId:3, x:350, count:3, size:10},
                    {platformId:4, x:470, count:2, size:10},
                    {platformId:6, x:430, count:2, size:10}
                ],
                coins: [
                    {x:90, y:410, size:8}, {x:210, y:360, size:8}, {x:330, y:300, size:8},
                    {x:450, y:240, size:8}, {x:310, y:180, size:8}, {x:410, y:120, size:8},
                    {x:70, y:410, size:8}, {x:190, y:360, size:8}, {x:310, y:300, size:8},
                    {x:430, y:240, size:8}, {x:290, y:180, size:8}, {x:540, y:60, size:8}
                ],
                bgColor: '#ffd8a8'
            }
        ];

        // å½“å‰å…³å¡æ•°æ®
        let currentLevelData = levelsData[currentLevel];
        let platforms = currentLevelData.platforms;
        let spikes = currentLevelData.spikes;
        let coins = [];

        // DOMå…ƒç´ 
        const startScreen = document.getElementById('startScreen');
        const levelSelectScreen = document.getElementById('levelSelectScreen');
        const winScreen = document.getElementById('winScreen');
        const winMessage = document.getElementById('winMessage');
        const nextLevelBtn = document.getElementById('nextLevelBtn');
        const transition = document.getElementById('transition');

        // åˆå§‹åŒ–å…³å¡æŒ‰é’®
        function initLevelButtons() {
            const levelButtons = document.getElementById('levelButtons');
            levelButtons.innerHTML = '';
            levelsData.forEach((_, index) => {
                const btn = document.createElement('button');
                btn.className = 'btn level-btn';
                btn.textContent = index + 1;
                btn.disabled = !unlockedLevels[index];
                btn.onclick = () => loadLevel(index);
                levelButtons.appendChild(btn);
            });
        }

        // åŠ è½½å…³å¡
        function loadLevel(levelIndex) {
            if (!unlockedLevels[levelIndex]) return;
            
            showTransition();
            setTimeout(() => {
                currentLevel = levelIndex;
                currentLevelData = levelsData[currentLevel];
                
                // é‡ç½®æ¸¸æˆçŠ¶æ€
                platforms = currentLevelData.platforms;
                spikes = currentLevelData.spikes;
                coins = currentLevelData.coins.map(coin => ({...coin, collected: false}));
                coinCount = 0;
                gameState = 'playing';
                
                // é‡ç½®è§’è‰²
                player.x = 50;
                player.y = 410;
                player.velocityY = 0;
                player.onGround = false;
                
                // éšè—ç•Œé¢
                startScreen.style.display = 'none';
                levelSelectScreen.style.display = 'none';
                winScreen.style.display = 'none';
                
                hideTransition();
            }, 500);
        }

        // é‡æ–°ç©å½“å‰å…³å¡
        function replayCurrentLevel() {
            loadLevel(currentLevel);
        }

        // è½¬åœºæ•ˆæœ
        function showTransition() {
            transition.style.opacity = 1;
        }
        function hideTransition() {
            setTimeout(() => {
                transition.style.opacity = 0;
            }, 100);
        }

        // ç•Œé¢åˆ‡æ¢
        function showStartScreen() {
            startScreen.style.display = 'block';
            levelSelectScreen.style.display = 'none';
            winScreen.style.display = 'none';
        }
        function showLevelSelect() {
            initLevelButtons();
            levelSelectScreen.style.display = 'block';
            startScreen.style.display = 'none';
            winScreen.style.display = 'none';
        }

        // é”®ç›˜æ§åˆ¶ï¼ˆå·²ç§»é™¤Fé”®å…¨å±åŠŸèƒ½ï¼‰
        document.addEventListener('keydown', e => {
            keys[e.key] = true;
            // Ré”®é‡æ–°å¼€å§‹
            if ((e.key === 'r' || e.key === 'R') && gameState !== 'menu') {
                replayCurrentLevel();
            }
        });
        document.addEventListener('keyup', e => keys[e.key] = false);

        // ç¢°æ’æ£€æµ‹
        function rectCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.w &&
                   rect1.x + rect1.w > rect2.x &&
                   rect1.y < rect2.y + rect2.h &&
                   rect1.y + rect1.h > rect2.y;
        }

        // è·å–å¹³å°Yåæ ‡
        function getPlatformY(platformId) {
            const platform = platforms.find(p => p.id === platformId);
            return platform ? platform.y : 0;
        }

        // æ›´æ–°è§’è‰²
        function updatePlayer() {
            if (gameState !== 'playing') return;

            // æ°´å¹³ç§»åŠ¨ + ç¦æ­¢ç©¿å¢™
            let moveX = 0;
            if (keys['ArrowLeft']) moveX = -player.speed;
            if (keys['ArrowRight']) moveX = player.speed;

            const futureX = player.x + moveX;
            const playerRectX = {x: futureX, y: player.y, w: player.size, h: player.size};
            let canMoveX = true;
            platforms.forEach(p => {
                if (rectCollision(playerRectX, p)) canMoveX = false;
            });
            if (canMoveX) player.x = futureX;

            // è·³è·ƒ
            if (keys['ArrowUp'] && player.onGround) {
                player.velocityY = -player.jumpPower;
                player.onGround = false;
            }

            // é‡åŠ›
            player.velocityY += player.gravity;
            
            // å‚ç›´ç§»åŠ¨ + ç¦æ­¢ç©¿å¢™
            const futureY = player.y + player.velocityY;
            const playerRectY = {x: player.x, y: futureY, w: player.size, h: player.size};
            let canMoveY = true;
            platforms.forEach(p => {
                if (rectCollision(playerRectY, p)) {
                    canMoveY = false;
                    if (player.velocityY > 0) {
                        player.y = p.y - player.size;
                        player.velocityY = 0;
                        player.onGround = true;
                    } else {
                        player.y = p.y + p.h;
                        player.velocityY = 0;
                    }
                }
            });
            if (canMoveY) {
                player.y = futureY;
                player.onGround = false;
            }

            // é‡‘å¸æ”¶é›†
            coins.forEach(coin => {
                if (!coin.collected && rectCollision(
                    {x: player.x, y: player.y, w: player.size, h: player.size},
                    {x: coin.x, y: coin.y, w: coin.size, h: coin.size}
                )) {
                    coin.collected = true;
                    coinCount++;
                }
            });

            // å°–åˆºç¢°æ’
            const playerHitbox = {x: player.x + 1, y: player.y + 1, w: player.size - 2, h: player.size - 2};
            spikes.forEach(s => {
                const platformY = getPlatformY(s.platformId);
                for (let i=0; i<s.count; i++) {
                    const spikeX = s.x + i*s.size;
                    const spikeHitbox = {x: spikeX + 2, y: platformY - s.size + 5, w: s.size - 4, h: s.size - 5};
                    if (rectCollision(playerHitbox, spikeHitbox)) {
                        gameState = 'lose';
                    }
                }
            });

            // è¾¹ç•Œæ£€æµ‹
            if (player.y > canvas.height + 50) {
                gameState = 'lose';
            }

            // ç»Ÿä¸€é€šå…³é€»è¾‘
            const totalCoins = coins.length;
            const endPlatform = platforms.find(p => p.id === 7);
            const playerRect = {x: player.x, y: player.y, w: player.size, h: player.size};
            const endPlatformRect = {
                x: endPlatform.x - 5,
                y: endPlatform.y - 5,
                w: endPlatform.w + 10,
                h: endPlatform.h + 10
            };

            if (gameState === 'playing' && coinCount === totalCoins && rectCollision(playerRect, endPlatformRect)) {
                gameState = 'win';
                if (currentLevel + 1 < levelsData.length) {
                    unlockedLevels[currentLevel + 1] = true;
                    localStorage.setItem('unlockedLevels', JSON.stringify(unlockedLevels));
                }
                winMessage.textContent = `ç¬¬${currentLevel + 1}å…³æ‰€æœ‰é‡‘å¸å·²æ”¶é›†ï¼ŒæŒ‘æˆ˜æˆåŠŸï¼`;
                nextLevelBtn.textContent = currentLevel + 1 < levelsData.length ? 'ä¸‹ä¸€å…³' : 'è¿”å›ä¸»èœå•';
                nextLevelBtn.onclick = currentLevel + 1 < levelsData.length ? () => loadLevel(currentLevel + 1) : showStartScreen;
                winScreen.style.display = 'block';
            }
        }

        // ç»˜åˆ¶æ¸¸æˆ
        function drawGame() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // èƒŒæ™¯
            ctx.fillStyle = currentLevelData.bgColor;
            ctx.fillRect(0, 0, originalWidth, originalHeight);

            // å¹³å°
            platforms.forEach(p => {
                ctx.fillStyle = p.color || '#000';
                ctx.fillRect(p.x, p.y, p.w, p.h);
                // ç»ˆç‚¹å¹³å°æ–‡å­—æ ‡è®°
                if (p.id === 7) {
                    ctx.fillStyle = '#fff';
                    ctx.font = '12px Courier New';
                    ctx.fillText('ç»ˆç‚¹', p.x + 5, p.y + 15);
                }
            });

            // å°–åˆº
            ctx.fillStyle = '#000';
            spikes.forEach(s => {
                const platformY = getPlatformY(s.platformId);
                for (let i=0; i<s.count; i++) {
                    const x = s.x + i*s.size;
                    ctx.beginPath();
                    ctx.moveTo(x + s.size/2, platformY - s.size);
                    ctx.lineTo(x, platformY);
                    ctx.lineTo(x + s.size, platformY);
                    ctx.fill();
                }
            });

            // é‡‘å¸
            ctx.fillStyle = '#ff0';
            coins.forEach(coin => {
                if (!coin.collected) ctx.fillRect(coin.x, coin.y, coin.size, coin.size);
            });

            // è§’è‰²
            ctx.fillStyle = '#000';
            ctx.fillRect(player.x, player.y, player.size, player.size);
            ctx.fillStyle = '#fff';
            ctx.font = '8px Courier New';
            ctx.fillText('c', player.x + 3, player.y + 9);

            // å…³å¡ä¿¡æ¯
            ctx.fillStyle = '#90f';
            ctx.font = '16px Courier New';
            ctx.fillText(`å…³å¡ ${currentLevel + 1} | é‡‘å¸ ${coinCount} / ${coins.length}`, 20, 30);

            // å¤±è´¥æç¤º
            if (gameState === 'lose') {
                ctx.fillStyle = '#000';
                ctx.font = '24px Courier New';
                ctx.fillText('GAME OVER', originalWidth/2 - 70, originalHeight/2);
                ctx.font = '16px Courier New';
                ctx.fillText('Press R to Restart', originalWidth/2 - 65, originalHeight/2 + 30);
            }
        }

        // æ¸¸æˆå¾ªç¯
        function gameLoop() {
            updatePlayer();
            drawGame();
            requestAnimationFrame(gameLoop);
        }

        // åˆå§‹åŒ–
        initLevelButtons();
        gameLoop();
    </script>
</body>
</html>
